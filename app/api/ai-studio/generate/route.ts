import { NextResponse } from 'next/server'
import { GoogleGenerativeAI } from '@google/generative-ai'

// Lazy initialization
let genAI: GoogleGenerativeAI | null = null

function getGeminiClient(): GoogleGenerativeAI {
  if (!genAI) {
    const apiKey = process.env.GOOGLE_API_KEY
    if (!apiKey) {
      throw new Error('GOOGLE_API_KEY is not configured')
    }
    genAI = new GoogleGenerativeAI(apiKey)
  }
  return genAI
}

interface Source {
  id: string
  type: 'pdf' | 'web' | 'youtube' | 'text' | 'image'
  title: string
  content?: string
  summary?: string
}

interface ImageSource {
  title: string
  imageDataUrl: string // base64 data URL
}

// Raw PCMì„ WAVë¡œ ë³€í™˜ (Gemini TTSëŠ” audio/L16 PCMì„ ë°˜í™˜)
function pcmToWav(pcmBuffer: Buffer, sampleRate: number = 24000, channels: number = 1, bitsPerSample: number = 16): Buffer {
  const byteRate = sampleRate * channels * (bitsPerSample / 8)
  const blockAlign = channels * (bitsPerSample / 8)
  const dataSize = pcmBuffer.length
  const headerSize = 44
  const fileSize = headerSize + dataSize - 8

  const wavBuffer = Buffer.alloc(headerSize + dataSize)

  // RIFF header
  wavBuffer.write('RIFF', 0)
  wavBuffer.writeUInt32LE(fileSize, 4)
  wavBuffer.write('WAVE', 8)

  // fmt chunk
  wavBuffer.write('fmt ', 12)
  wavBuffer.writeUInt32LE(16, 16) // fmt chunk size
  wavBuffer.writeUInt16LE(1, 20) // PCM format
  wavBuffer.writeUInt16LE(channels, 22)
  wavBuffer.writeUInt32LE(sampleRate, 24)
  wavBuffer.writeUInt32LE(byteRate, 28)
  wavBuffer.writeUInt16LE(blockAlign, 32)
  wavBuffer.writeUInt16LE(bitsPerSample, 34)

  // data chunk
  wavBuffer.write('data', 36)
  wavBuffer.writeUInt32LE(dataSize, 40)
  pcmBuffer.copy(wavBuffer, 44)

  return wavBuffer
}

type GenerationType = 'briefing' | 'faq' | 'timeline' | 'study-guide' | 'deep-dive' | 'slides' | 'video-overview' | 'briefing-doc' | 'audio-overview' | 'mindmap' | 'report' | 'flashcard' | 'quiz' | 'infographic' | 'data-table'

const GENERATION_PROMPTS: Record<GenerationType, { systemPrompt: string; outputFormat: string }> = {
  'briefing': {
    systemPrompt: `ë‹¹ì‹ ì€ ì „ë¬¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì „ë¬¸ì ì¸ ë¸Œë¦¬í•‘ ë¬¸ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# ë¸Œë¦¬í•‘ ë¬¸ì„œ

## ğŸ“‹ ìš”ì•½ (Executive Summary)
[2-3ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ë‚´ìš© ìš”ì•½]

## ğŸ”‘ í•µì‹¬ í¬ì¸íŠ¸
1. [ì£¼ìš” ë°œê²¬ì‚¬í•­ 1]
2. [ì£¼ìš” ë°œê²¬ì‚¬í•­ 2]
3. [ì£¼ìš” ë°œê²¬ì‚¬í•­ 3]

## ğŸ“Š ìƒì„¸ ë¶„ì„
[ìë£Œì˜ ì£¼ìš” ë‚´ìš©ì„ êµ¬ì¡°í™”í•˜ì—¬ ì„¤ëª…]

## ğŸ’¡ ì‹œì‚¬ì  ë° ê¶Œì¥ì‚¬í•­
- [ê¶Œì¥ì‚¬í•­ 1]
- [ê¶Œì¥ì‚¬í•­ 2]
- [ê¶Œì¥ì‚¬í•­ 3]

## ğŸ“ ì¶”ê°€ ì°¸ê³ ì‚¬í•­
[ê´€ë ¨ ì»¨í…ìŠ¤íŠ¸ë‚˜ ë°°ê²½ ì •ë³´]`
  },
  'faq': {
    systemPrompt: `ë‹¹ì‹ ì€ Q&A ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ì§ˆë¬¸ê³¼ ëª…í™•í•œ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# ìì£¼ ë¬»ëŠ” ì§ˆë¬¸ (FAQ)

**Q1. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q2. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q3. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q4. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q5. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q6. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q7. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q8. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q9. [ì§ˆë¬¸]**
A: [ë‹µë³€]

**Q10. [ì§ˆë¬¸]**
A: [ë‹µë³€]`
  },
  'timeline': {
    systemPrompt: `ë‹¹ì‹ ì€ íƒ€ì„ë¼ì¸ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œì—ì„œ ì‹œê°„ìˆœ ì´ë²¤íŠ¸ì™€ ë‹¨ê³„ë¥¼ ì¶”ì¶œí•˜ì—¬ ëª…í™•í•œ íƒ€ì„ë¼ì¸ì„ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# íƒ€ì„ë¼ì¸

## ğŸ• ì£¼ìš” ì´ë²¤íŠ¸/ë‹¨ê³„

### [ì‹œì /ë‹¨ê³„ 1]
- **ì´ë²¤íŠ¸**: [ì„¤ëª…]
- **ì˜í–¥/ê²°ê³¼**: [ì„¤ëª…]

### [ì‹œì /ë‹¨ê³„ 2]
- **ì´ë²¤íŠ¸**: [ì„¤ëª…]
- **ì˜í–¥/ê²°ê³¼**: [ì„¤ëª…]

### [ì‹œì /ë‹¨ê³„ 3]
- **ì´ë²¤íŠ¸**: [ì„¤ëª…]
- **ì˜í–¥/ê²°ê³¼**: [ì„¤ëª…]

## ğŸ“ˆ ì „ì²´ íë¦„ ìš”ì•½
[ì „ì²´ì ì¸ íë¦„ê³¼ íŒ¨í„´ ì„¤ëª…]

## ğŸ”® í–¥í›„ ì˜ˆìƒ
[í–¥í›„ ì§„í–‰ ë°©í–¥ì´ë‚˜ ì˜ˆìƒ ì‚¬í•­]`
  },
  'study-guide': {
    systemPrompt: `ë‹¹ì‹ ì€ êµìœ¡ ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ íš¨ê³¼ì ì¸ í•™ìŠµ ê°€ì´ë“œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# í•™ìŠµ ê°€ì´ë“œ

## ğŸ“š í•™ìŠµ ëª©í‘œ
ì´ ê°€ì´ë“œë¥¼ í†µí•´ ë°°ìš¸ ìˆ˜ ìˆëŠ” ë‚´ìš©:
1. [ëª©í‘œ 1]
2. [ëª©í‘œ 2]
3. [ëª©í‘œ 3]

## ğŸ”¤ í•µì‹¬ ê°œë… ë° ìš©ì–´
| ìš©ì–´ | ì„¤ëª… |
|------|------|
| [ìš©ì–´ 1] | [ì„¤ëª…] |
| [ìš©ì–´ 2] | [ì„¤ëª…] |
| [ìš©ì–´ 3] | [ì„¤ëª…] |

## ğŸ“– ì£¼ìš” ë‚´ìš© ì •ë¦¬

### ì„¹ì…˜ 1: [ì œëª©]
[í•µì‹¬ ë‚´ìš© ì„¤ëª…]

### ì„¹ì…˜ 2: [ì œëª©]
[í•µì‹¬ ë‚´ìš© ì„¤ëª…]

### ì„¹ì…˜ 3: [ì œëª©]
[í•µì‹¬ ë‚´ìš© ì„¤ëª…]

## âœï¸ ì—°ìŠµ ë¬¸ì œ
1. [ë¬¸ì œ 1]
2. [ë¬¸ì œ 2]
3. [ë¬¸ì œ 3]

## ğŸ’¡ í•µì‹¬ ì •ë¦¬
- [í•µì‹¬ í¬ì¸íŠ¸ 1]
- [í•µì‹¬ í¬ì¸íŠ¸ 2]
- [í•µì‹¬ í¬ì¸íŠ¸ 3]

## ğŸ“ ì¶”ê°€ í•™ìŠµ ìë£Œ
[ê´€ë ¨ ì£¼ì œë‚˜ ì‹¬í™” í•™ìŠµì„ ìœ„í•œ ì œì•ˆ]`
  },
  'deep-dive': {
    systemPrompt: `ë‹¹ì‹ ì€ ì‹¬ì¸µ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ê¹Šì´ ë¶„ì„í•˜ì—¬ ìˆ¨ê²¨ì§„ í†µì°°, íŒ¨í„´, ì—°ê²°ê³ ë¦¬ë¥¼ ë°œê²¬í•©ë‹ˆë‹¤.`,
    outputFormat: `# ì‹¬ì¸µ ë¶„ì„ (Deep Dive)

## ğŸ”¬ ë¶„ì„ ê°œìš”
[ë¶„ì„ ëŒ€ìƒê³¼ ì ‘ê·¼ ë°©ë²• ì„¤ëª…]

## ğŸ§© í•µì‹¬ ë°œê²¬ì‚¬í•­

### ë°œê²¬ 1: [ì œëª©]
- **ê´€ì°°**: [ë¬´ì—‡ì„ ë°œê²¬í–ˆëŠ”ì§€]
- **ì˜ë¯¸**: [ì™œ ì¤‘ìš”í•œì§€]
- **ì˜í–¥**: [ì–´ë–¤ ì˜í–¥ì´ ìˆëŠ”ì§€]

### ë°œê²¬ 2: [ì œëª©]
- **ê´€ì°°**: [ë¬´ì—‡ì„ ë°œê²¬í–ˆëŠ”ì§€]
- **ì˜ë¯¸**: [ì™œ ì¤‘ìš”í•œì§€]
- **ì˜í–¥**: [ì–´ë–¤ ì˜í–¥ì´ ìˆëŠ”ì§€]

## ğŸ”— íŒ¨í„´ ë° ì—°ê²°ê³ ë¦¬
[ë°ì´í„° ê°„ì˜ ê´€ê³„, ë°˜ë³µë˜ëŠ” íŒ¨í„´, ìˆ¨ê²¨ì§„ ì—°ê²°]

## ğŸ’ ìˆ¨ê²¨ì§„ í†µì°°
1. [í†µì°° 1]
2. [í†µì°° 2]
3. [í†µì°° 3]

## âš¡ ê°•ì ê³¼ ì•½ì  ë¶„ì„
**ê°•ì :**
- [ê°•ì  1]
- [ê°•ì  2]

**ì•½ì /ê°œì„ ì :**
- [ì•½ì  1]
- [ì•½ì  2]

## ğŸ¯ ì „ëµì  ì œì•ˆ
[ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì œì•ˆ]

## ğŸ“Œ ê²°ë¡ 
[í•µì‹¬ ë©”ì‹œì§€ì™€ ë‹¤ìŒ ë‹¨ê³„]`
  },
  'slides': {
    systemPrompt: `ë‹¹ì‹ ì€ í”„ë ˆì  í…Œì´ì…˜ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ íš¨ê³¼ì ì¸ í”„ë ˆì  í…Œì´ì…˜ ìŠ¬ë¼ì´ë“œ êµ¬ì¡°ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# í”„ë ˆì  í…Œì´ì…˜ ìŠ¬ë¼ì´ë“œ

## ìŠ¬ë¼ì´ë“œ 1: ì œëª©
**[í”„ë ˆì  í…Œì´ì…˜ ì œëª©]**
ë¶€ì œëª©: [í•µì‹¬ ë©”ì‹œì§€]

ğŸ“ ë°œí‘œì ë…¸íŠ¸: [ì˜¤í”„ë‹ ë©˜íŠ¸]

---

## ìŠ¬ë¼ì´ë“œ 2: ëª©ì°¨/ê°œìš”
- ì„¹ì…˜ 1: [ì œëª©]
- ì„¹ì…˜ 2: [ì œëª©]
- ì„¹ì…˜ 3: [ì œëª©]

ğŸ“ ë°œí‘œì ë…¸íŠ¸: [ì „ì²´ íë¦„ ì„¤ëª…]

---

## ìŠ¬ë¼ì´ë“œ 3: [í•µì‹¬ ë‚´ìš© 1]
â€¢ í¬ì¸íŠ¸ 1
â€¢ í¬ì¸íŠ¸ 2
â€¢ í¬ì¸íŠ¸ 3

ğŸ“ ë°œí‘œì ë…¸íŠ¸: [ìƒì„¸ ì„¤ëª…]

---

[10-15ê°œ ìŠ¬ë¼ì´ë“œ ê³„ì†...]

---

## ë§ˆì§€ë§‰ ìŠ¬ë¼ì´ë“œ: ìš”ì•½ ë° ê²°ë¡ 
**í•µì‹¬ ë©”ì‹œì§€:**
1. [ìš”ì•½ 1]
2. [ìš”ì•½ 2]
3. [ìš”ì•½ 3]

ğŸ“ ë°œí‘œì ë…¸íŠ¸: [ë§ˆë¬´ë¦¬ ë©˜íŠ¸ì™€ Q&A ì•ˆë‚´]`
  },
  'video-overview': {
    systemPrompt: `ë‹¹ì‹ ì€ NotebookLM ìŠ¤íƒ€ì¼ì˜ ì˜¤ë””ì˜¤ ê°œìš” ìƒì„±ê¸°ì…ë‹ˆë‹¤.
ì œê³µëœ ì†ŒìŠ¤ ìë£Œë¥¼ ë¶„ì„í•˜ê³ , ìŠ¬ë¼ì´ë“œë³„ ë‚˜ë ˆì´ì…˜ ëŒ€ë³¸ì„ ì‘ì„±í•©ë‹ˆë‹¤.

ì¤‘ìš”: ê° ìŠ¬ë¼ì´ë“œëŠ” [SLIDE:ë²ˆí˜¸:ì œëª©] í˜•ì‹ìœ¼ë¡œ ì‹œì‘í•˜ê³ , ê·¸ ì•„ë˜ì— TTSê°€ ì½ì„ ë‚˜ë ˆì´ì…˜ í…ìŠ¤íŠ¸ë§Œ ì‘ì„±í•©ë‹ˆë‹¤.
TTS í…ìŠ¤íŠ¸ì—ëŠ” ë§ˆí¬ë‹¤ìš´, íŠ¹ìˆ˜ë¬¸ì, íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì ˆëŒ€ ë„£ì§€ ë§ˆì„¸ìš”.`,
    outputFormat: `[SLIDE:1:ì˜¤í”„ë‹]
ì˜¤ëŠ˜ ì‚´í´ë³¼ ìë£ŒëŠ” [ì£¼ì œ]ì— ê´€í•œ ë‚´ìš©ì…ë‹ˆë‹¤. ì´ ìë£Œê°€ ì™œ ì¤‘ìš”í•œì§€, í•µì‹¬ì´ ë­”ì§€ ê°™ì´ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

[SLIDE:2:ìë£Œ ì†Œê°œ]
ë¨¼ì € ì´ ìë£Œì˜ ë°°ê²½ì„ ê°„ë‹¨íˆ ì„¤ëª…ë“œë¦¬ë©´, [ìë£Œì˜ ë§¥ë½ê³¼ ë°°ê²½ ì„¤ëª…]ì…ë‹ˆë‹¤. [ì™œ ì´ ìë£Œê°€ ë§Œë“¤ì–´ì¡ŒëŠ”ì§€ ì„¤ëª…]

[SLIDE:3:í•µì‹¬ í¬ì¸íŠ¸ 1]
ì²« ë²ˆì§¸ë¡œ ì£¼ëª©í•  ì ì€ [í•µì‹¬ í¬ì¸íŠ¸ 1]ì…ë‹ˆë‹¤. [êµ¬ì²´ì ì¸ ë‚´ìš© ì„¤ëª…] ì´ê²Œ ì™œ ì¤‘ìš”í•˜ëƒë©´, [ë¶„ì„ê³¼ í•´ì„]ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì‰½ê²Œ ë§í•´ì„œ [ì‰¬ìš´ ë¹„ìœ ë‚˜ ì˜ˆì‹œ]ë¼ê³  ìƒê°í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

[SLIDE:4:í•µì‹¬ í¬ì¸íŠ¸ 2]
ë‘ ë²ˆì§¸ë¡œ ì¤‘ìš”í•œ ê±´ [í•µì‹¬ í¬ì¸íŠ¸ 2]ì¸ë°ìš”. [êµ¬ì²´ì ì¸ ë‚´ìš©] ì´ ë¶€ë¶„ì˜ ì˜ë¯¸ëŠ” [ì‹œì‚¬ì ]ì…ë‹ˆë‹¤. ì‹¤ì œë¡œ [ì ìš© ê°€ëŠ¥ì„±ì´ë‚˜ ì˜í–¥]ì„ ìƒê°í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[SLIDE:5:í•µì‹¬ í¬ì¸íŠ¸ 3]
ì„¸ ë²ˆì§¸ëŠ” [í•µì‹¬ í¬ì¸íŠ¸ 3]ì…ë‹ˆë‹¤. [ìƒì„¸ ì„¤ëª…] ì•ì—ì„œ ë§ì”€ë“œë¦° ë‚´ìš©ê³¼ ì—°ê²°í•´ë³´ë©´, [ì—°ê²°ê³ ë¦¬ ì„¤ëª…]ì´ ë©ë‹ˆë‹¤.

[SLIDE:6:ë¶„ì„ ë° ì‹œì‚¬ì ]
ì´ ë‚´ìš©ë“¤ì„ ì¢…í•©í•´ë³´ë©´, [ì „ì²´ì ì¸ ë¶„ì„ê³¼ í•´ì„]ì…ë‹ˆë‹¤. ì‹œì‚¬ì ì€ [ì‹œì‚¬ì  ì„¤ëª…]ì…ë‹ˆë‹¤.

[SLIDE:7:ì •ë¦¬]
ì •ë¦¬í•˜ìë©´, ì²«ì§¸ [ìš”ì•½ 1], ë‘˜ì§¸ [ìš”ì•½ 2], ì…‹ì§¸ [ìš”ì•½ 3]ì…ë‹ˆë‹¤. ì´ìƒìœ¼ë¡œ [ì£¼ì œ] ë¶„ì„ì„ ë§ˆì¹˜ê² ìŠµë‹ˆë‹¤.

7-10ê°œ ìŠ¬ë¼ì´ë“œë¡œ êµ¬ì„±í•˜ê³ , ê° ìŠ¬ë¼ì´ë“œë³„ ë‚˜ë ˆì´ì…˜ì€ ìì—°ìŠ¤ëŸ½ê²Œ ì‘ì„±í•˜ì„¸ìš”.`
  },
  'briefing-doc': {
    systemPrompt: `ë‹¹ì‹ ì€ ì „ë¬¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì „ë¬¸ì ì¸ ë¸Œë¦¬í•‘ ë¬¸ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# ë¸Œë¦¬í•‘ ë¬¸ì„œ

## ğŸ“‹ ìš”ì•½ (Executive Summary)
[2-3ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ ë‚´ìš© ìš”ì•½]

## ğŸ”‘ í•µì‹¬ í¬ì¸íŠ¸
1. [ì£¼ìš” ë°œê²¬ì‚¬í•­ 1]
2. [ì£¼ìš” ë°œê²¬ì‚¬í•­ 2]
3. [ì£¼ìš” ë°œê²¬ì‚¬í•­ 3]

## ğŸ“Š ìƒì„¸ ë¶„ì„
[ìë£Œì˜ ì£¼ìš” ë‚´ìš©ì„ êµ¬ì¡°í™”í•˜ì—¬ ì„¤ëª…]

## ğŸ’¡ ì‹œì‚¬ì  ë° ê¶Œì¥ì‚¬í•­
- [ê¶Œì¥ì‚¬í•­ 1]
- [ê¶Œì¥ì‚¬í•­ 2]
- [ê¶Œì¥ì‚¬í•­ 3]

## ğŸ“ ì¶”ê°€ ì°¸ê³ ì‚¬í•­
[ê´€ë ¨ ì»¨í…ìŠ¤íŠ¸ë‚˜ ë°°ê²½ ì •ë³´]`
  },
  'audio-overview': {
    systemPrompt: `ë‹¹ì‹ ì€ ì „ë¬¸ ì˜¤ë””ì˜¤ ì½˜í…ì¸  í¬ë¦¬ì—ì´í„°ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ë¶„ì„í•˜ì—¬ ì²­ì·¨ìê°€ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆëŠ” ì˜¤ë””ì˜¤ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# ì˜¤ë””ì˜¤ ê°œìš”

## ğŸ™ï¸ ì˜¤í”„ë‹ (30ì´ˆ)
[ì¹œê·¼í•œ ì¸ì‚¬ì™€ ì£¼ì œ ì†Œê°œ]

## ğŸ“– ë³¸ë¬¸ (3-5ë¶„)
### ì„¹ì…˜ 1: [í•µì‹¬ ì£¼ì œ]
[ìƒì„¸ ì„¤ëª… - ì²­ì·¨ìê°€ ë“£ê¸°ë§Œ í•´ë„ ì´í•´í•  ìˆ˜ ìˆë„ë¡]

### ì„¹ì…˜ 2: [ì„¸ë¶€ ë‚´ìš©]
[ì˜ˆì‹œì™€ ë¹„ìœ ë¥¼ í™œìš©í•œ ì„¤ëª…]

### ì„¹ì…˜ 3: [ì¶”ê°€ ì •ë³´]
[ê´€ë ¨ ë§¥ë½ê³¼ ë°°ê²½]

## ğŸ¯ í•µì‹¬ ìš”ì•½ (30ì´ˆ)
- í¬ì¸íŠ¸ 1
- í¬ì¸íŠ¸ 2
- í¬ì¸íŠ¸ 3

## ğŸ‘‹ ë§ˆë¬´ë¦¬ (15ì´ˆ)
[ê°ì‚¬ ì¸ì‚¬ì™€ ë§ˆë¬´ë¦¬]`
  },
  'mindmap': {
    systemPrompt: `ë‹¹ì‹ ì€ ì‹œê°ì  ì‚¬ê³  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ë¶„ì„í•˜ì—¬ ì²´ê³„ì ì¸ ë§ˆì¸ë“œë§µ êµ¬ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì¤‘ì‹¬ ì£¼ì œì—ì„œ ê°€ì§€ê°€ ë»—ì–´ë‚˜ê°€ëŠ” í˜•íƒœë¡œ ì •ë³´ë¥¼ ì¡°ì§í™”í•©ë‹ˆë‹¤.`,
    outputFormat: `# ë§ˆì¸ë“œë§µ

## ğŸ¯ ì¤‘ì‹¬ ì£¼ì œ
**[í•µì‹¬ ì£¼ì œ]**

## ğŸŒ¿ ì£¼ìš” ê°€ì§€ 1: [ì¹´í…Œê³ ë¦¬ëª…]
- í•˜ìœ„ í•­ëª© 1.1
  - ì„¸ë¶€ ì‚¬í•­
  - ì„¸ë¶€ ì‚¬í•­
- í•˜ìœ„ í•­ëª© 1.2
  - ì„¸ë¶€ ì‚¬í•­

## ğŸŒ¿ ì£¼ìš” ê°€ì§€ 2: [ì¹´í…Œê³ ë¦¬ëª…]
- í•˜ìœ„ í•­ëª© 2.1
  - ì„¸ë¶€ ì‚¬í•­
- í•˜ìœ„ í•­ëª© 2.2
  - ì„¸ë¶€ ì‚¬í•­

## ğŸŒ¿ ì£¼ìš” ê°€ì§€ 3: [ì¹´í…Œê³ ë¦¬ëª…]
- í•˜ìœ„ í•­ëª© 3.1
- í•˜ìœ„ í•­ëª© 3.2

## ğŸŒ¿ ì£¼ìš” ê°€ì§€ 4: [ì¹´í…Œê³ ë¦¬ëª…]
- í•˜ìœ„ í•­ëª© 4.1
- í•˜ìœ„ í•­ëª© 4.2

## ğŸ”— ì—°ê²° ê´€ê³„
- [ê°€ì§€ 1] â†” [ê°€ì§€ 2]: ê´€ê³„ ì„¤ëª…
- [ê°€ì§€ 2] â†’ [ê°€ì§€ 3]: ì˜í–¥ ê´€ê³„`
  },
  'report': {
    systemPrompt: `ë‹¹ì‹ ì€ ì „ë¬¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¦¬í¬íŠ¸ ì‘ì„±ìì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ë¶„ì„í•˜ì—¬ ì²´ê³„ì ì´ê³  ì „ë¬¸ì ì¸ ë³´ê³ ì„œë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# ë¶„ì„ ë³´ê³ ì„œ

## ğŸ“‹ ê°œìš”
**ì‘ì„± ëª©ì **: [ë³´ê³ ì„œ ëª©ì ]
**ë¶„ì„ ëŒ€ìƒ**: [ë¶„ì„ ìë£Œ ìš”ì•½]

## ğŸ” í˜„í™© ë¶„ì„
### ì£¼ìš” ë°œê²¬ì‚¬í•­
1. [ë°œê²¬ì‚¬í•­ 1]
2. [ë°œê²¬ì‚¬í•­ 2]
3. [ë°œê²¬ì‚¬í•­ 3]

### ë°ì´í„° ë¶„ì„
- í•µì‹¬ ì§€í‘œ 1: [ìˆ˜ì¹˜/ë‚´ìš©]
- í•µì‹¬ ì§€í‘œ 2: [ìˆ˜ì¹˜/ë‚´ìš©]
- í•µì‹¬ ì§€í‘œ 3: [ìˆ˜ì¹˜/ë‚´ìš©]

## ğŸ’¡ ì¸ì‚¬ì´íŠ¸
### ê°•ì 
- [ê°•ì  1]
- [ê°•ì  2]

### ê°œì„  í•„ìš” ì˜ì—­
- [ê°œì„ ì  1]
- [ê°œì„ ì  2]

## ğŸ“Š ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­
### ê²°ë¡ 
[ì¢…í•©ì ì¸ ê²°ë¡  2-3ë¬¸ì¥]

### ê¶Œì¥ì‚¬í•­
1. **ë‹¨ê¸° (1-3ê°œì›”)**: [ê¶Œì¥ì‚¬í•­]
2. **ì¤‘ê¸° (3-6ê°œì›”)**: [ê¶Œì¥ì‚¬í•­]
3. **ì¥ê¸° (6ê°œì›”+)**: [ê¶Œì¥ì‚¬í•­]

## ğŸ“ ë¶€ë¡
[ì¶”ê°€ ì°¸ê³  ìë£Œ ë° ì¶œì²˜]`
  },
  'flashcard': {
    systemPrompt: `ë‹¹ì‹ ì€ êµìœ¡ ì½˜í…ì¸  ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œì—ì„œ í•µì‹¬ ê°œë…ì„ ì¶”ì¶œí•˜ì—¬ í•™ìŠµìš© í”Œë˜ì‹œì¹´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê° ì¹´ë“œëŠ” ì§ˆë¬¸-ë‹µë³€ í˜•ì‹ìœ¼ë¡œ ê¸°ì–µí•˜ê¸° ì‰½ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.`,
    outputFormat: `# í”Œë˜ì‹œì¹´ë“œ ì„¸íŠ¸

## ì¹´ë“œ 1
**Q**: [ì§ˆë¬¸]
**A**: [ë‹µë³€]
ğŸ“ íŒíŠ¸: [ê¸°ì–µ íŒ]

---

## ì¹´ë“œ 2
**Q**: [ì§ˆë¬¸]
**A**: [ë‹µë³€]
ğŸ“ íŒíŠ¸: [ê¸°ì–µ íŒ]

---

## ì¹´ë“œ 3
**Q**: [ì§ˆë¬¸]
**A**: [ë‹µë³€]
ğŸ“ íŒíŠ¸: [ê¸°ì–µ íŒ]

---

[10-20ê°œ ì¹´ë“œ ê³„ì†...]

---

## ë³µìŠµ ìš”ì•½
**í•µì‹¬ ê°œë… ì •ë¦¬**:
1. [ê°œë… 1]
2. [ê°œë… 2]
3. [ê°œë… 3]`
  },
  'quiz': {
    systemPrompt: `ë‹¹ì‹ ì€ êµìœ¡ í‰ê°€ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì´í•´ë„ë¥¼ ì ê²€í•  ìˆ˜ ìˆëŠ” í€´ì¦ˆ ë¬¸ì œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ë‹¤ì–‘í•œ ìœ í˜•ì˜ ë¬¸ì œë¥¼ í¬í•¨í•©ë‹ˆë‹¤.`,
    outputFormat: `# í€´ì¦ˆ

## ğŸ“ ê°ê´€ì‹ ë¬¸ì œ

### ë¬¸ì œ 1
[ì§ˆë¬¸]
- A) [ì„ íƒì§€]
- B) [ì„ íƒì§€]
- C) [ì„ íƒì§€]
- D) [ì„ íƒì§€]

**ì •ë‹µ**: [ì •ë‹µ]
**í•´ì„¤**: [í•´ì„¤]

---

### ë¬¸ì œ 2
[ì§ˆë¬¸]
- A) [ì„ íƒì§€]
- B) [ì„ íƒì§€]
- C) [ì„ íƒì§€]
- D) [ì„ íƒì§€]

**ì •ë‹µ**: [ì •ë‹µ]
**í•´ì„¤**: [í•´ì„¤]

---

## âœï¸ ë‹¨ë‹µí˜• ë¬¸ì œ

### ë¬¸ì œ 3
[ì§ˆë¬¸]

**ì •ë‹µ**: [ì •ë‹µ]
**í•´ì„¤**: [í•´ì„¤]

---

## ğŸ¤” ì„œìˆ í˜• ë¬¸ì œ

### ë¬¸ì œ 4
[ì§ˆë¬¸]

**ëª¨ë²” ë‹µì•ˆ**: [ë‹µì•ˆ]
**ì±„ì  ê¸°ì¤€**: [ê¸°ì¤€]

---

## ğŸ“Š ì •ë‹µ ë° í•´ì„¤
| ë¬¸ì œ | ì •ë‹µ | ë‚œì´ë„ |
|------|------|--------|
| 1 | [ì •ë‹µ] | â­ |
| 2 | [ì •ë‹µ] | â­â­ |
| 3 | [ì •ë‹µ] | â­â­ |
| 4 | [ì •ë‹µ] | â­â­â­ |`
  },
  'infographic': {
    systemPrompt: `ë‹¹ì‹ ì€ ì¸í¬ê·¸ë˜í”½ ë””ìì¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œë¥¼ ì‹œê°ì ìœ¼ë¡œ í‘œí˜„í•˜ê¸° ì¢‹ì€ ì¸í¬ê·¸ë˜í”½ êµ¬ì¡°ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. ìˆ«ì, í†µê³„, ë¹„êµ, í”„ë¡œì„¸ìŠ¤ë¥¼ ì‹œê°í™”í•©ë‹ˆë‹¤.`,
    outputFormat: `# ì¸í¬ê·¸ë˜í”½

## ğŸ“Œ í—¤ë“œë¼ì¸
**[í•µì‹¬ ë©”ì‹œì§€ - í•œ ë¬¸ì¥ìœ¼ë¡œ]**

## ğŸ“Š í•µì‹¬ í†µê³„
| í•­ëª© | ìˆ˜ì¹˜ | ì˜ë¯¸ |
|------|------|------|
| [í•­ëª©1] | [ìˆ˜ì¹˜] | [ì„¤ëª…] |
| [í•­ëª©2] | [ìˆ˜ì¹˜] | [ì„¤ëª…] |
| [í•­ëª©3] | [ìˆ˜ì¹˜] | [ì„¤ëª…] |

## ğŸ”„ í”„ë¡œì„¸ìŠ¤/ë‹¨ê³„
1ï¸âƒ£ **[ë‹¨ê³„ 1]**: [ì„¤ëª…]
   â¬‡ï¸
2ï¸âƒ£ **[ë‹¨ê³„ 2]**: [ì„¤ëª…]
   â¬‡ï¸
3ï¸âƒ£ **[ë‹¨ê³„ 3]**: [ì„¤ëª…]
   â¬‡ï¸
4ï¸âƒ£ **[ë‹¨ê³„ 4]**: [ì„¤ëª…]

## âš–ï¸ ë¹„êµ ë¶„ì„
| ê¸°ì¤€ | í•­ëª© A | í•­ëª© B |
|------|--------|--------|
| [ê¸°ì¤€1] | [ê°’] | [ê°’] |
| [ê¸°ì¤€2] | [ê°’] | [ê°’] |
| [ê¸°ì¤€3] | [ê°’] | [ê°’] |

## ğŸ¯ í•µì‹¬ í¬ì¸íŠ¸
âœ… [í¬ì¸íŠ¸ 1]
âœ… [í¬ì¸íŠ¸ 2]
âœ… [í¬ì¸íŠ¸ 3]

## ğŸ’¡ ê²°ë¡ 
[ì‹œê°ì ìœ¼ë¡œ ê¸°ì–µí•  í•µì‹¬ ë©”ì‹œì§€]`
  },
  'data-table': {
    systemPrompt: `ë‹¹ì‹ ì€ ë°ì´í„° ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì œê³µëœ ìë£Œì—ì„œ êµ¬ì¡°í™”ëœ ë°ì´í„°ë¥¼ ì¶”ì¶œí•˜ì—¬ ì²´ê³„ì ì¸ í‘œ í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.`,
    outputFormat: `# ë°ì´í„° í‘œ

## ğŸ“‹ ë°ì´í„° ê°œìš”
**ë°ì´í„° ì¶œì²˜**: [ì¶œì²˜]
**ë¶„ì„ ê¸°ì¤€**: [ê¸°ì¤€]
**ë°ì´í„° ê¸°ê°„**: [ê¸°ê°„]

## ğŸ“Š ì£¼ìš” ë°ì´í„° í‘œ

### í‘œ 1: [í‘œ ì œëª©]
| í•­ëª© | ê°’ 1 | ê°’ 2 | ê°’ 3 | ë¹„ê³  |
|------|------|------|------|------|
| [í•­ëª©1] | [ê°’] | [ê°’] | [ê°’] | [ì„¤ëª…] |
| [í•­ëª©2] | [ê°’] | [ê°’] | [ê°’] | [ì„¤ëª…] |
| [í•­ëª©3] | [ê°’] | [ê°’] | [ê°’] | [ì„¤ëª…] |
| **í•©ê³„/í‰ê· ** | [ê°’] | [ê°’] | [ê°’] | - |

### í‘œ 2: [í‘œ ì œëª©]
| ì¹´í…Œê³ ë¦¬ | ì„¸ë¶€ í•­ëª© | ìˆ˜ì¹˜ | ë¹„ìœ¨ |
|----------|----------|------|------|
| [ì¹´í…Œê³ ë¦¬1] | [í•­ëª©] | [ìˆ˜ì¹˜] | [%] |
| [ì¹´í…Œê³ ë¦¬2] | [í•­ëª©] | [ìˆ˜ì¹˜] | [%] |
| [ì¹´í…Œê³ ë¦¬3] | [í•­ëª©] | [ìˆ˜ì¹˜] | [%] |

## ğŸ“ˆ ë°ì´í„° ìš”ì•½
- **ìµœëŒ€ê°’**: [í•­ëª©] - [ê°’]
- **ìµœì†Œê°’**: [í•­ëª©] - [ê°’]
- **í‰ê· **: [ê°’]
- **íŠ¹ì´ì‚¬í•­**: [ì„¤ëª…]

## ğŸ’¡ ë°ì´í„° ì¸ì‚¬ì´íŠ¸
1. [ì¸ì‚¬ì´íŠ¸ 1]
2. [ì¸ì‚¬ì´íŠ¸ 2]
3. [ì¸ì‚¬ì´íŠ¸ 3]`
  }
}

export async function POST(req: Request) {
  try {
    const { type, prompt, sources, images } = await req.json() as {
      type: GenerationType
      prompt: string
      sources: Source[]
      images?: ImageSource[] // video-overviewì—ì„œ ì „ë‹¬ë˜ëŠ” ì´ë¯¸ì§€ë“¤
    }

    if (!type || !sources || sources.length === 0) {
      return NextResponse.json({ error: 'íƒ€ì…ê³¼ ì†ŒìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤' }, { status: 400 })
    }

    const generationConfig = GENERATION_PROMPTS[type]
    if (!generationConfig) {
      return NextResponse.json({ error: 'ì§€ì›í•˜ì§€ ì•ŠëŠ” ìƒì„± íƒ€ì…ì…ë‹ˆë‹¤' }, { status: 400 })
    }

    // Build context from sources
    const sourceContext = sources.map((s, i) => {
      const content = s.content || s.summary || ''
      return `[ì†ŒìŠ¤ ${i + 1}: ${s.title}]\níƒ€ì…: ${s.type}\në‚´ìš©:\n${content.slice(0, 15000)}`
    }).join('\n\n---\n\n')

    // Use Gemini for content generation
    const client = getGeminiClient()
    const model = client.getGenerativeModel({
      model: 'gemini-2.0-flash',
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 8192
      }
    })

    // video-overview: ì†ŒìŠ¤ ë¶„ì„ â†’ ìŠ¬ë¼ì´ë“œ êµ¬ì¡° ìƒì„± â†’ ìŠ¬ë¼ì´ë“œë³„ ëŒ€ë³¸ ì‘ì„± â†’ í¬ë¦¬ì—ì´í„° TTS
    if (type === 'video-overview') {
      console.log(`[Generate] video-overview - ì†ŒìŠ¤ ê¸°ë°˜ ìŠ¬ë¼ì´ë“œ ì¬êµ¬ì„± ì‹œì‘`)

      // ===== 1ë‹¨ê³„: ì†ŒìŠ¤ ìë£Œ ì‹¬ì¸µ ë¶„ì„ + ìŠ¬ë¼ì´ë“œ êµ¬ì¡° ìƒì„± =====
      const slideStructurePrompt = `ë‹¹ì‹ ì€ ìµœê³ ì˜ í”„ë ˆì  í…Œì´ì…˜ ì „ëµê°€ì…ë‹ˆë‹¤.
ì œê³µëœ ìë£Œë¥¼ ë¶„ì„í•˜ì—¬ ìœ íŠœë¸Œ ì„¤ëª… ì˜ìƒì— ì í•©í•œ ìŠ¬ë¼ì´ë“œ êµ¬ì¡°ë¥¼ ì„¤ê³„í•˜ì„¸ìš”.

## ì›ë³¸ ìë£Œ
${sourceContext}

## ìŠ¬ë¼ì´ë“œ êµ¬ì¡° ì„¤ê³„ ì›ì¹™
1. ìë£Œì˜ í•µì‹¬ ë©”ì‹œì§€ë¥¼ ì¶”ì¶œí•˜ì—¬ ë…¼ë¦¬ì  íë¦„ìœ¼ë¡œ ì¬êµ¬ì„±
2. ê° ìŠ¬ë¼ì´ë“œëŠ” í•˜ë‚˜ì˜ í•µì‹¬ í¬ì¸íŠ¸ë§Œ ë‹´ìŒ
3. ì‹œì²­ìê°€ ì‰½ê²Œ ì´í•´í•  ìˆ˜ ìˆëŠ” ìˆœì„œë¡œ ë°°ì—´
4. 8-12ê°œ ìŠ¬ë¼ì´ë“œ (ì˜¤í”„ë‹, ë³¸ë¡  6-10ê°œ, ë§ˆë¬´ë¦¬)

## ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì´ JSON í˜•ì‹ìœ¼ë¡œ)
\`\`\`json
{
  "title": "ì˜ìƒ ì œëª©",
  "summary": "ì „ì²´ ìš”ì•½ (1-2ë¬¸ì¥)",
  "slides": [
    {
      "slideNumber": 1,
      "slideTitle": "ìŠ¬ë¼ì´ë“œ ì œëª©",
      "keyPoint": "ì´ ìŠ¬ë¼ì´ë“œì˜ í•µì‹¬ ë©”ì‹œì§€ (1ë¬¸ì¥)",
      "details": ["ì„¸ë¶€ í¬ì¸íŠ¸ 1", "ì„¸ë¶€ í¬ì¸íŠ¸ 2", "ì„¸ë¶€ í¬ì¸íŠ¸ 3"],
      "visualSuggestion": "ì´ ìŠ¬ë¼ì´ë“œì— ì–´ìš¸ë¦¬ëŠ” ì‹œê°ìë£Œ ì„¤ëª…"
    }
  ]
}
\`\`\`

ìë£Œë¥¼ ê¹Šì´ ë¶„ì„í•˜ê³  ìŠ¬ë¼ì´ë“œ êµ¬ì¡°ë¥¼ ìƒì„±í•˜ì„¸ìš”.`

      const slideStructureResult = await model.generateContent(slideStructurePrompt)
      const slideStructureText = await slideStructureResult.response.text()
      console.log(`[Generate] ìŠ¬ë¼ì´ë“œ êµ¬ì¡° ìƒì„± ì™„ë£Œ`)

      // JSON íŒŒì‹±
      let slideStructure: {
        title: string
        summary: string
        slides: Array<{
          slideNumber: number
          slideTitle: string
          keyPoint: string
          details: string[]
          visualSuggestion: string
        }>
      }

      try {
        // JSON ë¸”ë¡ ì¶”ì¶œ
        const jsonMatch = slideStructureText.match(/```json\s*([\s\S]*?)\s*```/)
        const jsonText = jsonMatch ? jsonMatch[1] : slideStructureText
        slideStructure = JSON.parse(jsonText)
      } catch {
        console.error('[Generate] ìŠ¬ë¼ì´ë“œ êµ¬ì¡° JSON íŒŒì‹± ì‹¤íŒ¨, ê¸°ë³¸ êµ¬ì¡° ì‚¬ìš©')
        slideStructure = {
          title: 'ìë£Œ ë¶„ì„',
          summary: 'ì†ŒìŠ¤ ìë£Œ ê¸°ë°˜ ë¶„ì„ ì˜ìƒ',
          slides: [
            { slideNumber: 1, slideTitle: 'ì˜¤í”„ë‹', keyPoint: 'ì˜¤ëŠ˜ ì£¼ì œ ì†Œê°œ', details: [], visualSuggestion: '' },
            { slideNumber: 2, slideTitle: 'í•µì‹¬ ë‚´ìš©', keyPoint: 'ì£¼ìš” í¬ì¸íŠ¸', details: [], visualSuggestion: '' },
            { slideNumber: 3, slideTitle: 'ë§ˆë¬´ë¦¬', keyPoint: 'ìš”ì•½ ë° ì •ë¦¬', details: [], visualSuggestion: '' }
          ]
        }
      }

      // ===== 2ë‹¨ê³„: ìŠ¬ë¼ì´ë“œë³„ í¬ë¦¬ì—ì´í„° ëŒ€ë³¸ ì‘ì„± =====
      const slidesForScript = slideStructure.slides.map(s =>
        `[ìŠ¬ë¼ì´ë“œ ${s.slideNumber}: ${s.slideTitle}]
í•µì‹¬: ${s.keyPoint}
ì„¸ë¶€: ${s.details.join(', ')}`
      ).join('\n\n')

      const creatorScriptPrompt = `ë‹¹ì‹ ì€ ì¸ê¸° ìœ íŠœë¸Œ í¬ë¦¬ì—ì´í„°ì…ë‹ˆë‹¤. ì‹œì²­ìì—ê²Œ ì¹œê·¼í•˜ê³  ìƒë™ê° ìˆê²Œ ì„¤ëª…í•˜ëŠ” ëŒ€ë³¸ì„ ì‘ì„±í•˜ì„¸ìš”.

[ìë£Œ]
${slidesForScript}

${sourceContext.slice(0, 5000)}

[ìŠ¤íƒ€ì¼ ê°€ì´ë“œ]
1. ì¹œê·¼í•˜ê³  ìì—°ìŠ¤ëŸ¬ìš´ ë§íˆ¬ (ë‰´ìŠ¤ ì•µì»¤ì²˜ëŸ¼ ë”±ë”±í•˜ì§€ ì•Šê²Œ)
2. ì¤‘ê°„ì¤‘ê°„ í˜¸í¡ê³¼ ë¦¬ë“¬ê°: "ì,", "ê·¸ë˜ì„œìš”,", "ê·¼ë°ìš”,", "ìŒ..."
3. ê°ì • í‘œí˜„: "ì™€ ì •ë§ ì‹ ê¸°í•˜ì£ ?", "ì´ê²Œ í•µì‹¬ì¸ë°ìš”!", "ëŒ€ë‹¨í•˜ì§€ ì•Šë‚˜ìš”?"
4. ì²­ìì™€ ì†Œí†µí•˜ëŠ” ëŠë‚Œ: "ì—¬ëŸ¬ë¶„", "ë‹¤ë“¤ ì•„ì‹œì£ ?", "ê¶ê¸ˆí•˜ì‹œì£ ?"

[ì˜ˆì‹œ]
"ì, ì˜¤ëŠ˜ì€ ì •ë§ í¥ë¯¸ë¡œìš´ ì£¼ì œë¥¼ ê°€ì ¸ì™”ëŠ”ë°ìš”. ë°”ë¡œ ì¸ê³µì§€ëŠ¥ì— ëŒ€í•œ ì´ì•¼ê¸°ì…ë‹ˆë‹¤! ìš”ì¦˜ AIê°€ ì •ë§ í•«í•˜ì–ì•„ìš”? ê·¼ë°ìš”, ê·¸ì¤‘ì—ì„œë„ LLMì´ë¼ëŠ” ê²Œ ìˆëŠ”ë°, ì´ê²Œ ë­ëƒë©´ìš”... ì‰½ê²Œ ë§í•´ì„œ ëŒ€í™”ë¥¼ í•  ìˆ˜ ìˆëŠ” AIì˜ˆìš”. ì‹ ê¸°í•˜ì£ ? ì, ê·¸ëŸ¼ ì¢€ ë” ìì„¸íˆ ì•Œì•„ë³¼ê¹Œìš”?"

[ë¶„ëŸ‰: ${process.env.NODE_ENV === 'development' ? '30ì´ˆ ì •ë„' : '1ë¶„ 30ì´ˆ ì •ë„'}]

ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì—†ì´ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë¡œ ì¶œë ¥í•˜ì„¸ìš”.`

      const creatorScriptResult = await model.generateContent(creatorScriptPrompt)
      const creatorScriptRaw = await creatorScriptResult.response.text()

      // TTSìš© ëŒ€ë³¸: ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì œê±°
      const creatorScript = creatorScriptRaw
        .replace(/^#{1,6}\s+/gm, '')  // # í—¤ë”© ì œê±°
        .replace(/\*\*([^*]+)\*\*/g, '$1')  // **êµµì€ê¸€ì”¨** â†’ êµµì€ê¸€ì”¨
        .replace(/\*([^*]+)\*/g, '$1')  // *ê¸°ìš¸ì„* â†’ ê¸°ìš¸ì„
        .replace(/^[-*]\s+/gm, '')  // - ë˜ëŠ” * ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
        .replace(/^---+$/gm, '')  // --- êµ¬ë¶„ì„  ì œê±°
        .replace(/`([^`]+)`/g, '$1')  // `ì½”ë“œ` â†’ ì½”ë“œ
        .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')  // [ë§í¬](url) â†’ ë§í¬
        .replace(/\n{3,}/g, '\n\n')  // ì—°ì† ì¤„ë°”ê¿ˆ ì •ë¦¬
        .trim()

      console.log(`[Generate] í¬ë¦¬ì—ì´í„° ëŒ€ë³¸ ìƒì„± ì™„ë£Œ (TTSìš© ì •ë¦¬ë¨)`)

      // ===== 3ë‹¨ê³„: Gemini 2.5 Flash TTS (Single Voice) =====
      let audioUrl: string | undefined

      if (creatorScript.length > 0 && genAI) {
        try {
          console.log(`[Generate] Gemini 2.5 Flash TTS ì‹œì‘...`)

          const ttsModel = genAI.getGenerativeModel({
            model: 'gemini-2.5-flash-preview-tts',
          })

          const ttsResponse = await ttsModel.generateContent({
            contents: [{ role: 'user', parts: [{ text: creatorScript }] }],
            generationConfig: {
              responseModalities: ['AUDIO'],
              speechConfig: {
                voiceConfig: {
                  prebuiltVoiceConfig: { voiceName: 'Kore' } // í•œêµ­ì–´ ìì—°ìŠ¤ëŸ¬ìš´ ë‚¨ì„±
                }
              }
            } as any
          })

          const audioData = ttsResponse.response.candidates?.[0]?.content?.parts?.[0]
          if (audioData && 'inlineData' in audioData && audioData.inlineData?.data) {
            // Gemini TTSëŠ” raw PCM ë°˜í™˜ â†’ WAVë¡œ ë³€í™˜
            const pcmBuffer = Buffer.from(audioData.inlineData.data, 'base64')
            const wavBuffer = pcmToWav(pcmBuffer, 24000, 1, 16)
            audioUrl = `data:audio/wav;base64,${wavBuffer.toString('base64')}`
            console.log(`[Generate] Gemini TTS ì™„ë£Œ, WAV í¬ê¸°: ${wavBuffer.length} bytes`)
          }
        } catch (err) {
          console.error('[Generate] Gemini TTS error:', err)
        }
      }

      // í”„ë¡ íŠ¸ì—”ë“œìš© slides í˜•íƒœë¡œ ë³€í™˜ (ë‹¨ì¼ ìŠ¬ë¼ì´ë“œ - ì „ì²´ ëŒ€ë³¸ + ì˜¤ë””ì˜¤)
      const slides = [{
        number: 1,
        title: slideStructure.title,
        narration: creatorScript,  // TTSìš© ì •ë¦¬ëœ ëŒ€ë³¸
        bulletPoints: slideStructure.slides.slice(0, 4).map(s => s.keyPoint),
        audioUrl: audioUrl
      }]

      // í™”ë©´ í‘œì‹œìš© ì½˜í…ì¸  (ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì—†ì´)
      const formattedContent = `${slideStructure.title}

${slideStructure.summary}

ëŒ€ë³¸:
${creatorScriptRaw}`

      return NextResponse.json({
        success: true,
        content: formattedContent,
        type,
        slides,  // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©í•  ìŠ¬ë¼ì´ë“œ ë°ì´í„°
        script: creatorScriptRaw,
        audioUrl
      })
    }

    // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ í…ìŠ¤íŠ¸ ê¸°ë°˜ ìƒì„±
    const fullPrompt = `${generationConfig.systemPrompt}

## ìë£Œ
${sourceContext}

## ìš”ì²­
${prompt}

## ì¶œë ¥ í˜•ì‹
ë‹¤ìŒ í˜•ì‹ì— ë§ì¶° í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

${generationConfig.outputFormat}

ìœ„ í˜•ì‹ì„ ì°¸ê³ í•˜ì—¬ ì œê³µëœ ìë£Œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. ìë£Œì— ì—†ëŠ” ë‚´ìš©ì€ ì¶”ì¸¡í•˜ì§€ ë§ê³ , ìë£Œì—ì„œ ì§ì ‘ì ìœ¼ë¡œ ë„ì¶œí•  ìˆ˜ ìˆëŠ” ë‚´ìš©ë§Œ í¬í•¨í•´ì£¼ì„¸ìš”.`

    const result = await model.generateContent(fullPrompt)
    const content = await result.response.text()

    return NextResponse.json({
      success: true,
      content,
      type
    })
  } catch (error) {
    console.error('Content generation error:', error)
    return NextResponse.json(
      { error: 'ì½˜í…ì¸  ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤' },
      { status: 500 }
    )
  }
}
